<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>맞춤형 지원사업 플랫폼</title>
  <link rel="stylesheet" href="./smp.css" />
</head>
<body>
  <!-- ================= 헤더 ================= -->
  <header>
    <div class="nav">
      <button class="menu-toggle" id="menuToggle">☰</button>
      <div class="brand"><span class="dot"></span>맞춤형 지원사업 플랫폼</div>
      <div class="actions">
        <button class="btn ghost small" id="btn-saved">저장함(0)</button>
        <button class="btn small" id="btn-reset">초기화</button>
        <button class="btn acc small" id="btn-search">검색</button>
        <div class="auth">
          <button class="btn ghost small" id="authBtn">로그인</button>
          <div id="authMenu" class="auth-menu">
            <a id="myPageLink" href="../mypage.html" style="display:none">마이페이지</a>
            <button id="logoutBtn" type="button" style="display:none">로그아웃</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ================= 전체 레이아웃 ================= -->
  <div class="layout">
    <!-- ===== 사이드바 ===== -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>카테고리</h3>
        <div class="menu-item active"><span>전체</span><span class="count">0</span></div>
        <div class="menu-item"><span>주거</span><span class="count">0</span></div>
        <div class="menu-item"><span>일자리</span><span class="count">0</span></div>
        <div class="menu-item"><span>교육</span><span class="count">0</span></div>
        <div class="menu-item"><span>금융</span><span class="count">0</span></div>
        <div class="menu-item"><span>복지</span><span class="count">0</span></div>
      </div>

      <div class="sidebar-section">
        <h3>최근 본 지원사업</h3>
        <div class="muted" style="text-align:center">최근 본 항목이 없습니다</div>
      </div>

      <div class="sidebar-section">
        <h3>유용한 링크</h3>
        <a class="menu-item" href="../faq.html"><span>자주 묻는 질문</span></a>
        <a class="menu-item" href="../guide.html"><span>이용 가이드</span></a>
        <a class="menu-item" href="../contact.html"><span>문의하기</span></a>
      </div>
    </aside>

    <!-- ===== 메인 콘텐츠 ===== -->
    <main class="main-content">
      <section class="hero container">
        <h1>당신에게 맞는 지원사업을 한눈에</h1>
        <p class="muted">키워드와 조건을 선택해 보세요.</p>

        <!-- 인기 검색 태그 -->
        <div style="margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
            <div style="font-weight:600;color:#adc0d4">인기 검색</div>
            <div class="chiprow" id="popularTags"></div>
          </div>
        </div>

        <!-- 검색 필터 -->
        <div class="filters" id="filters">
          <div class="f" style="grid-column: span 6">
            <label for="keyword">키워드</label>
            <input class="input" id="keyword" placeholder="예: 전세자금, 창업, 교육" />
          </div>
          <div class="f" style="grid-column: span 3">
            <label>지역</label>
            <select class="select" id="region">
              <option value="">전국</option>
              <option>서울</option><option>부산</option><option>대구</option><option>인천</option>
              <option>광주</option><option>대전</option><option>울산</option><option>세종</option>
              <option>경기</option><option>강원</option><option>충북</option><option>충남</option>
              <option>전북</option><option>전남</option><option>경북</option><option>경남</option><option>제주</option>
            </select>
          </div>
          <div class="f" style="grid-column: span 3">
            <label>분야</label>
            <select class="select" id="category">
              <option value="">전체</option>
              <option>주거</option><option>일자리</option><option>교육</option>
              <option>금융</option><option>복지</option>
            </select>
          </div>
          <div class="f" style="grid-column: span 3">
            <label>마감여부</label>
            <select class="select" id="deadline">
              <option value="open">진행중만</option>
              <option value="all">전체</option>
              <option value="closed">마감만</option>
            </select>
          </div>
          <div class="f" style="grid-column: span 12; display:flex; gap:8px; align-items:center; margin-top:4px;">
            <button class="btn small" id="btn-search-run">검색 실행</button>
            <button class="btn small ghost" id="btn-clear">조건 초기화</button>
          </div>
        </div>
      </section>

      <!-- 검색 결과 영역 -->
      <section class="container">
        <div class="toolbar">
          <div id="count" class="muted">검색 결과 0건</div>
          <div>
            <select class="select" id="sort">
              <option value="relevance">정확도순</option>
              <option value="latest">최신 등록순</option>
            </select>
          </div>
        </div>

        <div class="results" id="results"></div>
        <div class="empty" id="empty" style="display:none">조건에 맞는 사업이 없습니다.</div>
      </section>

      <footer class="container">© 2025 맞춤형 지원사업 플랫폼</footer>
    </main>
  </div>

  <!-- ================= 스크립트 ================= -->
  <script>
  let allPrograms = [];

  // 페이지 로드 시 초기 불러오기
  window.addEventListener("DOMContentLoaded", async () => {
    await loadPrograms();
    document.getElementById("btn-search-run").addEventListener("click", runSearch);
    document.getElementById("btn-clear").addEventListener("click", clearFilters);

    // ✅ 엔터키로 검색 실행 기능 추가
    document.getElementById("keyword").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        runSearch();
      }
    });
    document.getElementById("region").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        runSearch();
      }
    });
    document.getElementById("category").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        runSearch();
      }
    });
    document.getElementById("deadline").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        runSearch();
      }
    });
  });

  // API 호출
  async function loadPrograms() {
    try {
      console.log("📡 복지로 API 호출 중...");
      const response = await fetch("http://localhost:8080/api/welfare?page=1&perPage=20");
      if (!response.ok) throw new Error("API 오류: " + response.status);

      const data = await response.json();
      const list = data.data || [];

      allPrograms = list.map((item, i) => ({
        id: "W" + (i + 1),
        title: item["서비스명"] || "제목 없음",
        host: item["소관부처명"] || "기관 미상",
        category: "복지",
        region: "전국",
        benefit: item["서비스상세"] || "",
        targets: item["서비스요약"] || "",
        link: item["서비스URL"] || "#",
        start: "2025-01-01",
        end: "2025-12-31",
      }));

      renderResults(allPrograms);
    } catch (err) {
      console.error("❌ API 호출 실패:", err);
    }
  }

  // 검색 조건 적용
  function runSearch() {
    const keyword = document.getElementById("keyword").value.trim();
    const region = document.getElementById("region").value;
    const category = document.getElementById("category").value;
    const deadline = document.getElementById("deadline").value;

    const filtered = allPrograms.filter((p) => {
      const matchKeyword =
        !keyword ||
        p.title.includes(keyword) ||
        p.targets.includes(keyword) ||
        p.benefit.includes(keyword);
      const matchRegion = !region || p.region === region;
      const matchCategory = !category || p.category === category;
      const matchDeadline =
        deadline === "all" || deadline === "open" ? true : false;

      return matchKeyword && matchRegion && matchCategory && matchDeadline;
    });

    renderResults(filtered);
  }

  // 초기화
  function clearFilters() {
    document.getElementById("keyword").value = "";
    document.getElementById("region").value = "";
    document.getElementById("category").value = "";
    document.getElementById("deadline").value = "open";
    renderResults(allPrograms);
  }

  // 결과 렌더링
  function renderResults(list) {
    const container = document.getElementById("results");
    const countEl = document.getElementById("count");
    const emptyEl = document.getElementById("empty");
    container.innerHTML = "";

    if (!list || list.length === 0) {
      emptyEl.style.display = "block";
      countEl.innerText = "검색 결과 0건";
      return;
    }

    emptyEl.style.display = "none";
    countEl.innerText = `검색 결과 ${list.length}건`;

    list.forEach((item) => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="card-body">
          <h3>${item.title}</h3>
          <p class="muted">${item.region} · ${item.category}</p>
          <p>${item.benefit}</p>
          <p><small>대상: ${item.targets}</small></p>
          <p><small>기관: ${item.host}</small></p>
          <a href="${item.link}" target="_blank" class="btn small">자세히 보기</a>
        </div>
      `;
      container.appendChild(card);
    });
  }
  </script>

  <link rel="stylesheet" href="./smp.css" />
</body>
</html>
